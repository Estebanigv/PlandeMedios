---
import { siteConfig } from '@/data/site';
import { socialLinks } from '@/data/social';

export interface BreadcrumbItem {
  name: string;
  url: string;
}

interface Props {
  title: string;
  description: string;
  image?: string;
  url?: string;
  type?: 'website' | 'article' | 'service' | 'product';
  keywords?: string[];
  author?: string;
  publishedTime?: string;
  modifiedTime?: string;
  breadcrumbs?: BreadcrumbItem[];
  schemaType?: 'Organization' | 'Article' | 'Service' | 'WebPage' | 'Product';
  article?: {
    author?: string;
    publishedTime?: string;
    modifiedTime?: string;
    tags?: string[];
  };
  service?: {
    name?: string;
    description?: string;
    provider?: string;
  };
}

const {
  title,
  description,
  image,
  url,
  type = 'website',
  keywords = [],
  author,
  publishedTime,
  modifiedTime,
  breadcrumbs = [],
  schemaType = 'Organization',
  article,
  service
} = Astro.props;

// Use siteConfig for defaults
const pageTitle = title ? `${title} | ${siteConfig.name}` : siteConfig.name;
const pageDescription = description || siteConfig.description;
const pageImage = image ? new URL(image, siteConfig.url).toString() : new URL(siteConfig.ogImage, siteConfig.url).toString();
const pageUrl = url || new URL(Astro.url.pathname, siteConfig.url).toString();

// Build canonical URL
const canonicalURL = Astro.site
  ? new URL(Astro.url.pathname, Astro.site)
  : pageUrl;

// Default keywords
const defaultKeywords = [
  'plan de medios',
  'contenido digital',
  'publicidad digital',
  'Tour Graphic',
  'Tour Motor',
  'Tour Innovación',
  'marketing digital',
  'contenido audiovisual',
  'innovación digital'
];

const allKeywords = [...new Set([...defaultKeywords, ...keywords])];

// Generate breadcrumb schema
const breadcrumbSchema = breadcrumbs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.name,
    "item": new URL(item.url, siteConfig.url).toString()
  }))
} : null;

// Generate dynamic schema based on type
const generateSchema = () => {
  const baseSchema = {
    "@context": "https://schema.org"
  };

  switch (schemaType) {
    case 'Article':
      return {
        ...baseSchema,
        "@type": "Article",
        "headline": title,
        "description": description,
        "image": pageImage,
        "author": {
          "@type": "Person",
          "name": article?.author || author || siteConfig.author
        },
        "publisher": {
          "@type": "Organization",
          "name": siteConfig.name,
          "logo": {
            "@type": "ImageObject",
            "url": new URL(siteConfig.logo, siteConfig.url).toString()
          }
        },
        "datePublished": article?.publishedTime || publishedTime,
        "dateModified": article?.modifiedTime || modifiedTime || article?.publishedTime || publishedTime,
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": pageUrl
        }
      };

    case 'Service':
      return {
        ...baseSchema,
        "@type": "Service",
        "name": service?.name || title,
        "description": service?.description || description,
        "provider": {
          "@type": "Organization",
          "name": service?.provider || siteConfig.name,
          "url": siteConfig.url
        },
        "areaServed": {
          "@type": "Country",
          "name": "Global"
        },
        "serviceType": service?.name || title
      };

    case 'WebPage':
      return {
        ...baseSchema,
        "@type": "WebPage",
        "name": title,
        "description": description,
        "url": pageUrl,
        "inLanguage": siteConfig.language,
        "isPartOf": {
          "@type": "WebSite",
          "name": siteConfig.name,
          "url": siteConfig.url
        }
      };

    case 'Organization':
    default:
      return {
        ...baseSchema,
        "@type": "Organization",
        "name": siteConfig.name,
        "description": siteConfig.description,
        "url": siteConfig.url,
        "logo": new URL(siteConfig.logo, siteConfig.url).toString(),
        "contactPoint": {
          "@type": "ContactPoint",
          "telephone": siteConfig.contact.phone,
          "contactType": "customer service",
          "email": siteConfig.contact.email,
          "availableLanguage": [siteConfig.language]
        },
        "address": {
          "@type": "PostalAddress",
          "addressLocality": siteConfig.contact.address.city,
          "addressCountry": siteConfig.contact.address.country
        },
        "sameAs": socialLinks.map(link => link.url)
      };
  }
};

const schemaData = generateSchema();
---

<!-- Primary Meta Tags -->
<meta name="title" content={pageTitle} />
<meta name="description" content={pageDescription} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={pageUrl} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:image" content={pageImage} />
<meta property="og:site_name" content={siteConfig.name} />
<meta property="og:locale" content={siteConfig.locale} />

{article && (
  <>
    <meta property="article:author" content={article.author || author} />
    {article.publishedTime && <meta property="article:published_time" content={article.publishedTime} />}
    {article.modifiedTime && <meta property="article:modified_time" content={article.modifiedTime} />}
    {article.tags && article.tags.map(tag => <meta property="article:tag" content={tag} />)}
  </>
)}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={pageUrl} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />
<meta name="twitter:image" content={pageImage} />

<!-- Additional SEO Tags -->
<meta name="keywords" content={allKeywords.join(', ')} />
<meta name="author" content={author || siteConfig.author} />
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
<meta name="language" content="Spanish" />
<meta name="generator" content={Astro.generator} />

<!-- Geographic Tags -->
<meta name="geo.region" content={siteConfig.contact.address.country} />
<meta name="geo.placename" content={siteConfig.contact.address.city} />

<!-- Schema.org structured data - Organization/Main Entity -->
<script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

<!-- Schema.org structured data - Breadcrumbs -->
{breadcrumbSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
)}
